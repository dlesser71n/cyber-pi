apiVersion: batch/v1
kind: Job
metadata:
  name: hunting-dashboard
  namespace: cyber-pi-intel
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: dashboard
        image: python:3.11-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Installing dependencies..."
            pip install --quiet redis neo4j

            cat > /tmp/dashboard.py << 'PYTHON'
            import asyncio
            import json
            from datetime import datetime, timezone
            import redis.asyncio as redis
            from neo4j import GraphDatabase

            async def show_dashboard():
                print("=" * 80)
                print("ðŸ” THREAT HUNTING DASHBOARD")
                print("=" * 80)
                print(f"â° {datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')}")
                print()

                # Connect
                redis_client = await redis.from_url(
                    "redis://:cyber-pi-redis-2025@redis.cyber-pi-intel.svc.cluster.local:6379",
                    encoding="utf-8",
                    decode_responses=True
                )

                driver = GraphDatabase.driver(
                    "bolt://neo4j.cyber-pi-intel.svc.cluster.local:7687",
                    auth=("neo4j", "cyber-pi-neo4j-2025")
                )

                # Get threat counts
                query = """
                MATCH (t:CyberThreat)
                RETURN
                    count(t) as total,
                    count(CASE WHEN toLower(t.title) CONTAINS 'zero-day' THEN 1 END) as zero_days,
                    count(CASE WHEN toLower(t.title) CONTAINS 'apt' THEN 1 END) as apt,
                    count(CASE WHEN toLower(t.title) CONTAINS 'ransomware' THEN 1 END) as ransomware,
                    count(CASE WHEN t.source CONTAINS 'CISA KEV' THEN 1 END) as kev
                """

                with driver.session() as session:
                    result = session.run(query)
                    stats = dict(result.single())

                print("ðŸ“Š THREAT INTELLIGENCE")
                print("-" * 80)
                print(f"Total Threats:     {stats['total']:,}")
                print(f"Zero-Days:         {stats['zero_days']}")
                print(f"APT Threats:       {stats['apt']}")
                print(f"Ransomware:        {stats['ransomware']}")
                print(f"CISA KEV:          {stats['kev']}")
                print()

                # Alert queue
                queue_len = await redis_client.llen("queue:alerts")
                print("ðŸš¨ ALERT QUEUE")
                print("-" * 80)
                print(f"Alerts Pending:    {queue_len}")

                if queue_len > 0:
                    print()
                    print("Sample Alerts:")
                    alerts = await redis_client.lrange("queue:alerts", 0, 2)
                    for alert_json in alerts:
                        try:
                            alert = json.loads(alert_json)
                            severity = alert.get('severity', 'unknown').upper()
                            icon = "ðŸ”´" if severity == "CRITICAL" else "ðŸŸ¡"
                            title = alert.get('title', alert.get('cve', 'Unknown'))[:60]
                            print(f"  {icon} [{severity}] {title}")
                        except:
                            pass
                print()

                # Hunter status
                print("ðŸŽ¯ ACTIVE HUNTERS")
                print("-" * 80)
                print("Hunter              Schedule            Status")
                print("-" * 80)
                print("Zero-Day Hunter     Every hour          âœ… Active")
                print("APT Detector        Every 6 hours       âœ… Active")
                print("CISA KEV Monitor    Every 15 minutes    âœ… Active")
                print()

                # System health
                print("ðŸ’š SYSTEM HEALTH")
                print("-" * 80)
                print("Redis:              âœ… Connected")
                print("Neo4j:              âœ… Connected")
                print("Automation:         âœ… Running")
                print()

                print("=" * 80)
                print("âœ… Autonomous Threat Hunting System Operational")
                print("=" * 80)

                await redis_client.close()
                driver.close()

            asyncio.run(show_dashboard())
            PYTHON

            python3 /tmp/dashboard.py

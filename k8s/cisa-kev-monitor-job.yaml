apiVersion: batch/v1
kind: Job
metadata:
  name: cisa-kev-monitor
  namespace: cyber-pi
spec:
  template:
    spec:
      containers:
      - name: hunter
        image: python:3.11-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            pip install --quiet redis
            cat > /tmp/hunter.py << 'EOF'
            import redis
            from datetime import datetime, timedelta
            from collections import defaultdict

            def monitor_kev():
                print("=" * 80)
                print("ğŸ¯ CISA KEV THREAT HUNTER")
                print("=" * 80)
                
                # Connect to Redis
                r = redis.Redis(
                    host='redis.cyber-pi.svc.cluster.local',
                    port=6379,
                    password='cyber-pi-redis-2025',
                    decode_responses=True
                )
                
                try:
                    r.ping()
                    print("âœ… Connected to Redis\n")
                except Exception as e:
                    print(f"âŒ Redis connection failed: {e}")
                    return
                
                # Get all KEV keys
                kev_keys = r.keys('cisa:kev:CVE-*')
                print(f"ğŸ“Š Analyzing {len(kev_keys)} Known Exploited Vulnerabilities\n")
                
                # Analysis
                vendors = defaultdict(int)
                products = defaultdict(int)
                recent_kevs = []
                critical_actions = []
                upcoming_deadlines = []
                
                today = datetime.utcnow().date()
                
                for key in kev_keys:
                    vuln = r.hgetall(key)
                    
                    # Count by vendor
                    vendor = vuln.get('vendor', 'Unknown')
                    vendors[vendor] += 1
                    
                    # Count by product
                    product = vuln.get('product', 'Unknown')
                    products[product] += 1
                    
                    # Check date added (recent = last 30 days)
                    date_added_str = vuln.get('date_added', '')
                    if date_added_str:
                        try:
                            date_added = datetime.strptime(date_added_str, '%Y-%m-%d').date()
                            days_ago = (today - date_added).days
                            if days_ago <= 30:
                                recent_kevs.append({
                                    'cve': vuln.get('cve_id'),
                                    'vendor': vendor,
                                    'product': product,
                                    'vuln': vuln.get('vulnerability', ''),
                                    'days_ago': days_ago,
                                    'date_added': date_added_str
                                })
                        except:
                            pass
                    
                    # Check due dates (upcoming = next 30 days)
                    due_date_str = vuln.get('due_date', '')
                    if due_date_str:
                        try:
                            due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date()
                            days_until = (due_date - today).days
                            if 0 <= days_until <= 30:
                                upcoming_deadlines.append({
                                    'cve': vuln.get('cve_id'),
                                    'vendor': vendor,
                                    'product': product,
                                    'vuln': vuln.get('vulnerability', ''),
                                    'due_date': due_date_str,
                                    'days_until': days_until
                                })
                        except:
                            pass
                    
                    # Critical actions needed
                    action = vuln.get('required_action', '')
                    if 'discontinue' in action.lower() or 'immediately' in action.lower():
                        critical_actions.append({
                            'cve': vuln.get('cve_id'),
                            'vendor': vendor,
                            'product': product,
                            'action': action[:100]
                        })
                
                # Sort and display results
                print("ğŸ”¥ TOP 10 VENDORS WITH MOST KEVs:")
                print("-" * 80)
                for vendor, count in sorted(vendors.items(), key=lambda x: x[1], reverse=True)[:10]:
                    print(f"  {vendor:30} {count:4} vulnerabilities")
                
                print(f"\nğŸ¯ RECENT KEVs (Last 30 days): {len(recent_kevs)}")
                print("-" * 80)
                recent_kevs.sort(key=lambda x: x['days_ago'])
                for kev in recent_kevs[:10]:
                    print(f"  {kev['cve']:20} {kev['vendor']:15} {kev['product']:20}")
                    print(f"    Added {kev['days_ago']} days ago ({kev['date_added']})")
                    print(f"    {kev['vuln'][:70]}...")
                    print()
                
                print(f"â° UPCOMING DEADLINES (Next 30 days): {len(upcoming_deadlines)}")
                print("-" * 80)
                upcoming_deadlines.sort(key=lambda x: x['days_until'])
                for deadline in upcoming_deadlines[:10]:
                    urgency = "ğŸš¨ URGENT" if deadline['days_until'] <= 7 else "âš ï¸  WARNING"
                    print(f"  {urgency} {deadline['cve']:20} Due in {deadline['days_until']} days ({deadline['due_date']})")
                    print(f"    {deadline['vendor']:15} {deadline['product']:20}")
                    print(f"    {deadline['vuln'][:70]}...")
                    print()
                
                print(f"ğŸš¨ CRITICAL ACTIONS REQUIRED: {len(critical_actions)}")
                print("-" * 80)
                for action in critical_actions[:5]:
                    print(f"  {action['cve']:20} {action['vendor']:15} {action['product']:20}")
                    print(f"    Action: {action['action']}...")
                    print()
                
                # Summary
                print("=" * 80)
                print("ğŸ“Š THREAT HUNTING SUMMARY")
                print("=" * 80)
                print(f"  Total KEVs Analyzed: {len(kev_keys)}")
                print(f"  Unique Vendors: {len(vendors)}")
                print(f"  Recent Additions (30d): {len(recent_kevs)}")
                print(f"  Upcoming Deadlines (30d): {len(upcoming_deadlines)}")
                print(f"  Critical Actions: {len(critical_actions)}")
                print("=" * 80)
                
                # Store analysis results
                r.set('threat:kev:last_analysis', datetime.utcnow().isoformat())
                r.set('threat:kev:recent_count', len(recent_kevs))
                r.set('threat:kev:upcoming_deadlines', len(upcoming_deadlines))
                r.set('threat:kev:critical_actions', len(critical_actions))
                
                print("\nâœ… Threat hunting complete!")

            if __name__ == "__main__":
                monitor_kev()
            EOF
            
            python /tmp/hunter.py
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
      restartPolicy: Never
  backoffLimit: 1

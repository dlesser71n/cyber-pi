apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cve-import
  namespace: cyber-pi
spec:
  template:
    spec:
      containers:
      - name: importer
        image: python:3.11-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Installing dependencies..."
            pip install --quiet redis tqdm
            
            echo "Copying import script..."
            cp /scripts/import_cves_to_redis.py /tmp/
            
            echo "Running import..."
            cd /tmp
            python3 import_cves_to_redis.py
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: data
          mountPath: /home/david/projects/cyber-pi/data/cve_import
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: REDIS_HOST
          value: "redis.cyber-pi.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          value: "cyber-pi-redis-2025"
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
      volumes:
      - name: scripts
        hostPath:
          path: /home/david/projects/cyber-pi/src/bootstrap
          type: Directory
      - name: data
        hostPath:
          path: /home/david/projects/cyber-pi/data/cve_import
          type: Directory
      restartPolicy: Never
  backoffLimit: 1

apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-loader-script
  namespace: cyber-pi-intel
data:
  load_redis.py: |
    #!/usr/bin/env python3
    import json
    import redis
    from tqdm import tqdm
    import time
    
    print("ðŸ”„ Loading CVEs to Redis...")
    
    # Connect to Redis via service name with authentication
    import os
    redis_password = os.getenv('REDIS_PASSWORD', '')
    r = redis.Redis(host='redis', port=6379, password=redis_password, decode_responses=False)
    
    # Load CVEs
    with open('/data/all_cves_neo4j.json') as f:
        cves = json.load(f)
    
    print(f"ðŸ“– Loaded {len(cves):,} CVEs from file")
    
    # Load with batching
    pipe = r.pipeline()
    batch_size = 1000
    loaded = 0
    
    for i, cve in enumerate(tqdm(cves, desc="Loading")):
        cve_id = cve['cve_id']
        pipe.set(f"cve:{cve_id}", json.dumps(cve))
        
        # Index by severity
        cvss = cve.get('cvss_v3_score') or cve.get('cvss_v2_score') or 0
        if cvss >= 9.0:
            pipe.sadd("cve:index:severity:critical", cve_id)
        elif cvss >= 7.0:
            pipe.sadd("cve:index:severity:high", cve_id)
        elif cvss >= 4.0:
            pipe.sadd("cve:index:severity:medium", cve_id)
        else:
            pipe.sadd("cve:index:severity:low", cve_id)
        
        # Index by vendors
        for vendor in cve.get('affected_vendors', []):
            pipe.sadd(f"cve:index:vendor:{vendor}", cve_id)
        
        # Index by CWEs
        for cwe in cve.get('cwes', []):
            pipe.sadd(f"cve:index:cwe:{cwe}", cve_id)
        
        loaded += 1
        
        if loaded % batch_size == 0:
            pipe.execute()
            pipe = r.pipeline()
    
    # Execute remaining
    if loaded % batch_size != 0:
        pipe.execute()
    
    print(f"\nâœ… Loaded {loaded:,} CVEs to Redis")
    print(f"ðŸ” Verify: redis-cli -h redis DBSIZE")
---
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cve-loader
  namespace: cyber-pi-intel
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: loader
        image: python:3.11-slim
        command: ["/bin/bash", "-c"]
        args:
        - |
          pip install redis tqdm > /dev/null 2>&1
          python3 /scripts/load_redis.py
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: cyber-pi-credentials
              key: redis-password
        volumeMounts:
        - name: data
          mountPath: /data
        - name: script
          mountPath: /scripts
      volumes:
      - name: data
        hostPath:
          path: /home/david/projects/cyber-pi/data/cve_import
          type: Directory
      - name: script
        configMap:
          name: redis-loader-script
          defaultMode: 0755

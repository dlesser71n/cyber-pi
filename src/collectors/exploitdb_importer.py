#!/usr/bin/env python3
"""
Exploit-DB Importer
Imports exploit data from local Exploit-DB repository
Links exploits to CVEs for weaponization tracking
"""

import redis
import json
import os
import csv
from pathlib import Path
from datetime import datetime
from tqdm import tqdm

print("=" * 80)
print("ðŸ’£ EXPLOIT-DB IMPORTER")
print("=" * 80)
print()

# Configuration
EXPLOITDB_PATH = Path(os.getenv('EXPLOITDB_PATH', '/home/david/projects/cyber-pi/data/exploit-db'))

if not EXPLOITDB_PATH.exists():
    print(f"âŒ Exploit-DB not found at {EXPLOITDB_PATH}")
    print("   Run: git clone https://gitlab.com/exploit-database/exploitdb.git")
    exit(1)

# Connect to Redis
redis_host = os.getenv('REDIS_HOST', 'redis.cyber-pi.svc.cluster.local')
redis_password = os.getenv('REDIS_PASSWORD', 'cyber-pi-redis-2025')

print(f"ðŸ”Œ Connecting to Redis...")
r = redis.Redis(host=redis_host, port=6379, password=redis_password, decode_responses=True)
r.ping()
print("âœ… Redis connected")
print()

# Load exploits from CSV
csv_file = EXPLOITDB_PATH / 'files_exploits.csv'

if not csv_file.exists():
    print(f"âŒ Exploits CSV not found: {csv_file}")
    exit(1)

print(f"ðŸ“‚ Loading exploits from {csv_file}...")

exploits = []
with open(csv_file, 'r', encoding='utf-8', errors='ignore') as f:
    reader = csv.DictReader(f)
    for row in reader:
        exploits.append(row)

print(f"âœ… Loaded {len(exploits):,} exploits")
print()

# Import to Redis
print("ðŸ’¾ Storing exploits in Redis...")
stored = 0
cve_links = 0

for exploit in tqdm(exploits, desc="Importing exploits"):
    try:
        exploit_id = exploit.get('id', '')
        if not exploit_id:
            continue
        
        # Store exploit
        exploit_key = f"exploitdb:exploit:{exploit_id}"
        
        exploit_data = {
            'id': exploit_id,
            'file': exploit.get('file', ''),
            'description': exploit.get('description', '')[:500],
            'date': exploit.get('date', ''),
            'author': exploit.get('author', ''),
            'type': exploit.get('type', ''),
            'platform': exploit.get('platform', ''),
            'port': exploit.get('port', ''),
            'source': 'exploit-db'
        }
        
        # Extract CVEs from description or codes field
        codes = exploit.get('codes', '')
        cves = []
        if codes:
            # codes field contains CVE IDs
            for code in codes.split(';'):
                code = code.strip()
                if code.startswith('CVE-'):
                    cves.append(code)
        
        if cves:
            exploit_data['cves'] = ','.join(cves)
            
            # Create reverse mapping: CVE -> Exploits
            for cve in cves:
                cve_exploit_key = f"cve:exploits:{cve}"
                r.sadd(cve_exploit_key, exploit_id)
                cve_links += 1
        
        r.hset(exploit_key, mapping=exploit_data)
        stored += 1
        
    except Exception as e:
        pass

print()
print("=" * 80)
print("âœ… EXPLOIT-DB IMPORT COMPLETE")
print("=" * 80)
print(f"   Exploits stored: {stored:,}")
print(f"   CVE links created: {cve_links:,}")
print()

# Store metadata
r.set('exploitdb:import:total', stored)
r.set('exploitdb:import:cve_links', cve_links)
r.set('exploitdb:import:timestamp', datetime.utcnow().isoformat())

print("âœ… Done!")
